# DeadLock(교착상태)

프로세스가 자원을 얻지 못해서 다음 처리를 하지 못하는 상태

시스템적으로 한정된 자원을 여러 곳에서 사용하려고 할 때 발생



#### 데드락 발생하는 경우

<img src="https://github.com/kimmy01/Today.I.Learned/blob/main/images/%EB%8D%B0%EB%93%9C%EB%9D%BD.jpg" width="500px">

현재 서로 원하는 자원이 상대방에게 할당되어 있어 두 프로세스는 무한정 대기 상태에 빠짐 => `데드락`


* 멀티 프로그래밍 환경에서 한정된 자원을 얻기 위해 서로 경쟁하는 상황 발생
* 한 프로세스가 자원을 요청했을 때, 동시에 그 자원을 사용할 수 없는 상황이 발생할 수 있음, 이 때 프로세스는 대기 상태로 들어감
* 대기 상태로 들어간 프로세스들이 실행 상태로 변경될 수 없을 때 `데드락`발생

#### 데드락 발생 조건

아래 4가지 모두 성립해야 데드락 발생!

1. **상호 배제(Mutual exclusion (Mutex))**

   자원은 한 번에 한 프로세스만 사용 가능

2. **점유 대기(Hold and wait)**

   최소한 하나의 자원을 점유하고 있으면서 다른 프로세스에 할당되어 사용하고 있는 자원을 추가로 점유하기 위해 대기하는 프로세스가 존재해야 함

3. **비선점(No preemption)**

   다른 프로세스에 할당된 자원은 사용이 끝날 때까지 강제로 빼앗을 수 없음

4. **순환대기(Circular wait)**

   프로세스의 집합에서 순환 형태로 자원을 대기하고 있어야 함

#### 데드락 예방 & 회피 방법

1. **예방**

   데드락 발생 조건 중 한 가지 제거하면서 해결 (자원 낭비 매우 심함)

   * 상호 배제 부정: 여러 프로세스가 공유 자원 사용
   * 점유 대기 부정: 프로세스 실행 전 모든 자원 할당
   * 비선점 부정: 자원 점유 중인 프로세스가 다른 자원 요구할 때 가진 자원 반납
   * 순환 대기 부정: 자원에 고유 번호 할당 후 순서대로 자원 요구

2. **회피**

   은행원 알고리즘

   * 은행에서 모든 고객의 요구가 충족되도록 현금을 할당하는 데에서 유래
   * 프로세스가 자원 요구할 때, 시스템은 자원을 할당한 후에도 안정 상태로 남아있게 되는 지 사전에 검사해서 데드락 회피
   * 안정 상태면 자원 할당, 아니면 다른 프로세스들이 자원 해지할 때까지 대기

#### 데드락 탐지  & 회복

데드락이 되도록 허용한다음 회복시키는 방법

1. **탐지**

   자원 할당 그래프 통해 데드락 탐지

   자원 요청 시, 탐지 알고리즘을 실행 시켜서 그에 대한 오버헤드 발생

2. **회복**

   데드락 일으킨 프로세스 종료하거나, 할당된 자원을 해제시켜서 회복시키는 방법

   * **프로세스 종료 방법**

     데드락 상태 프로세스 모두 중지

     데드락 제거될 때까지 하나씩 프로세스 중지

   * **자원 선점 방법**

     데드락 프로세스가 점유하고 있는 자원을 선점해서 다른 프로세스에게 할당 (해당 프로세스 일시 정지)

     우선 순위 낮은 프로세스나 수행 횟수 적은 프로세스 위주로 프로세스 자원 선점

#### 배고픈 철학자 문제

철학자 다섯명이 원형 식탁에 둘러 앉아 생각하다가 배고플 때 밥을 먹는데, 양쪽에 각각 젓가락이 한 짝씩 놓여있고 밥 먹을 때 다음 과정을 따름

1. 왼쪽 젓가락부터 집어든다. 다른 철학자가 이미 왼쪽 젓가락 쓰고 있으면 그가 내려놓을 때까지 생각하며 대기 
2. 왼쪽 들었으면 오른쪽 집어든다. 들 수 없으면 1번과 마찬가지로 들 수 있을 때까지 생각하며 대기 
3. 두 젓가락 모두 들었으면 일정시간 동안 식사
4. 식사 마치면 오른쪽 젓가락 내려놓고, 그 다음 왼쪽 젓가락 내려놓음
5. 다시 생각하다가 배고프면 1번부터 반복

=> 만약 모든 철학자가 동시에 배고파서 왼쪽 젓가락 집어들면? 오른쪽 젓가락을 들 수 있는 철학자 아무도 없음, 기아상태에 빠지게 됨

##### 데드락 발생 조건

1. Mutual Exclusion - 젓가락 한 번에 한 철학자만 사용 가능
2. Hold and Wait - 집어든 젓가락 계속 들고 있는 채로 사용중인 반대쪽 젓가락 기다림
3. No preemption - 이미 누가 집어든 젓가락 강제로 뺏을 수 없음
4. Circular Wait - 모든 철학자들이 자기 오른쪽에 앉은 철학자가 젓가락 놓기를 기다림

##### 해결 방법 중 한 가지

id가 짝수인 철학자는 왼쪽부터, id가 홀수인 철학자는 오른쪽부터 젓가락 들 수 있게 하기
